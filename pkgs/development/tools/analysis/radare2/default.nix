{stdenv, fetchFromGitHub
, ninja, meson , pkgconfig
, libusb, readline, libewf, perl, zlib, openssl
, gtk2 ? null, vte ? null, gtkdialog ? null
, python ? null
, ruby ? null
, lua ? null
, useX11, rubyBindings, pythonBindings, luaBindings
}:

assert useX11 -> (gtk2 != null && vte != null && gtkdialog != null);
assert rubyBindings -> ruby != null;
assert pythonBindings -> python != null;


let
  inherit (stdenv.lib) optional;
  #<generated>
  # DO NOT EDIT! Automatically generated by ./update.py
  version_commit = "19004";
  gittap = "2.8.0";
  gittip = "a76b965410aba07b4ef8b96d90b25b271c2003dd";
  version = "2.8.0";
  sha256 = "1d9rkzc3vychy2h1bnywwx4why83rr18r0lvvl1cqx87ad5awcjk";
  cs_tip = "782ea67e17a391ca0d3faafdc365b335a1a8930a";
  cs_sha256 = "1maww4ir78a193pm3f8lr2kdkizi7rywn68ffa65ipyr7j4pl6i4";
  #</generated>
in
stdenv.mkDerivation rec {
  name = "radare2-${version}";

  src = fetchFromGitHub {
    owner = "radare";
    repo = "radare2";
    rev = version;
    inherit sha256;
  };

  postPatch = let
    capstone = fetchFromGitHub {
      owner = "aquynh";
      repo = "capstone";
      # version from $sourceRoot/shlr/Makefile
      rev = cs_tip;
      sha256 = cs_sha256;
    };
  in ''
    if ! grep -F "CS_TIP=${cs_tip}" shlr/Makefile; then echo "CS_TIP mismatch"; exit 1; fi
    # When using meson, it expects capstone source relative to build directory
    mkdir -p build/shlr
    ln -s ${capstone} build/shlr/capstone
  '';

  postInstall = ''
    ln -s $out/bin/radare2 $out/bin/r2
    install -D -m755 $src/binr/r2pm/r2pm $out/bin/r2pm
  '';

  mesonFlags = [
    "-Dr2_version_commit=${version_commit}"
    "-Dr2_gittap=${gittap}"
    "-Dr2_gittip=${gittip}"
  ];

  enableParallelBuilding = true;

  nativeBuildInputs = [ pkgconfig ninja meson ];
  buildInputs = [ readline libusb libewf perl zlib openssl]
    ++ optional useX11 [gtkdialog vte gtk2]
    ++ optional rubyBindings [ruby]
    ++ optional pythonBindings [python]
    ++ optional luaBindings [lua];

  meta = {
    description = "unix-like reverse engineering framework and commandline tools";
    homepage = http://radare.org/;
    license = stdenv.lib.licenses.gpl2Plus;
    maintainers = with stdenv.lib.maintainers; [raskin makefu mic92];
    platforms = with stdenv.lib.platforms; linux;
    inherit version;
  };
}
